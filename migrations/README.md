
# Deployment Script README

This README provides comprehensive instructions and explanations for deploying and configuring the `DAARDistributor`, `APRStaking`, `DAAR`, and `DAARION` smart contracts using the provided deployment script. The deployment script is designed to ensure that contract addresses (IDs) remain consistent across deployments by checking for existing deployments before deploying new ones.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Overview](#overview)
- [Deployment Script Explanation](#deployment-script-explanation)
- [Step-by-Step Deployment Guide](#step-by-step-deployment-guide)
- [Important Notes](#important-notes)
- [Troubleshooting](#troubleshooting)
- [Security Considerations](#security-considerations)
- [Contributing](#contributing)
- [License](#license)

## Prerequisites

Before running the deployment script, ensure you have the following:

- **Node.js and NPM:** Install Node.js (v12 or higher) and NPM from [nodejs.org](https://nodejs.org/).
- **Truffle:** Install Truffle globally using `npm install -g truffle`.
- **OpenZeppelin Contracts and Upgrades Plugins:**

  ```bash
  npm install @openzeppelin/contracts
  npm install @openzeppelin/truffle-upgrades
  ```

- **Web3.js:** Ensure Web3.js is installed:

  ```bash
  npm install web3
  ```

- **Ethereum Client or Test Network:** You need access to an Ethereum network (e.g., Ganache, Ropsten, Mainnet).
- **Accounts and Private Keys:**

  - **Deployer Account:** An Ethereum account with enough ETH to cover gas costs.
  - **Owner Address:** The Gnosis Safe Wallet address (`0x39c8e3807B864A633bd83C34995d7A3a18d0b7e8` in the script).

- **Existing Contracts:**

  - **DAAR Contract:** Deployed at `0x0C2F6a057D9086BA96F612fEfEaC5353d5D48E13`.
  - **DAARION Contract:** Deployed at `0xDC818BC212BEC15726626eA0b15a147795399E32`.

## Overview

The deployment script performs the following actions:

1. **Checks for Existing Deployments:** It attempts to retrieve existing proxy contracts for `DAARDistributor` and `APRStaking` to maintain consistent contract addresses.
2. **Deploys Contracts if Necessary:** If proxies do not exist, it deploys new proxy contracts with the correct initialization parameters.
3. **Configures Contracts:**

   - Sets wallets in `DAAR` and `DAARION` contracts.
   - Assigns the `WalletD` role in `DAAR` to the `DAARDistributor` contract.
   - Transfers ownership of all contracts to the Gnosis Safe Wallet.

4. **Ensures Proper Interactions and Permissions:** Uses appropriate methods for interacting with contracts and handles account permissions correctly.

## Deployment Script Explanation

The deployment script is written in JavaScript and uses Truffle's migration system. Below is an explanation of each part of the script.

### Imports and Initializations

```javascript
const { deployProxy, upgradeProxy } = require('@openzeppelin/truffle-upgrades');
const DAARDistributor = artifacts.require("DAARDistributor");
const APRStaking = artifacts.require("APRStaking");
const DAAR = artifacts.require("DAAR");
const DAARION = artifacts.require("DAARION");
const Web3 = require('web3');
```

- **OpenZeppelin Upgrades Plugin:** Provides functions for deploying and upgrading proxy contracts.
- **Artifacts:** Contract artifacts generated by Truffle.
- **Web3:** Used for blockchain interactions.

### Module Exports

```javascript
module.exports = async function (deployer, network, accounts) { /* ... */ };
```

- **Deployer:** Truffle's deployment system object.
- **Network:** The network being deployed to.
- **Accounts:** Array of accounts provided by the network.

### Owner and Contract Addresses

```javascript
const ownerAddress = '0x39c8e3807B864A633bd83C34995d7A3a18d0b7e8';
const daarAddress = '0x0C2F6a057D9086BA96F612fEfEaC5353d5D48E13';
const daarionAddress = '0xDC818BC212BEC15726626eA0b15a147795399E32';
```

- **Owner Address:** The Gnosis Safe Wallet that will own the contracts.
- **Existing Contract Addresses:** Addresses of deployed `DAAR` and `DAARION` contracts.

### Web3 Initialization and Account Management

```javascript
const web3 = new Web3(deployer.provider);
const unlockedAccounts = await web3.eth.getAccounts();
const deployerAccount = unlockedAccounts[0];
```

- **Web3 Instance:** Initialized with the provider from the deployer.
- **Unlocked Accounts:** Accounts available for signing transactions.
- **Deployer Account:** The account used for deploying contracts and signing transactions.

### Contract Instance Declarations

```javascript
let daarDistributor;
let aprStaking;
let daarContract;
let daarionContract;
```

- **Contract Instances:** Variables to hold instances of the contracts.

### Maintaining Contract Addresses

#### Retrieving Existing Proxies

```javascript
try {
  const ProxyAdmin = artifacts.require('@openzeppelin/contracts-upgradeable/proxy/ProxyAdmin.sol');
  const proxyAdmin = await ProxyAdmin.deployed();
  const daarDistributorAddress = await proxyAdmin.getProxyAddress(DAARDistributor.contractName);
  // ...
} catch (error) {
  // Deploy new proxy
}
```

- **ProxyAdmin:** Used to interact with existing proxy contracts.
- **getProxyAddress:** Retrieves the address of the existing proxy.

#### Deploying New Proxies

```javascript
daarDistributor = await deployProxy(
  DAARDistributor,
  [daarAddress, daarionAddress, ownerAddress, 2592000],
  { deployer, initializer: 'initialize' }
);
```

- **deployProxy:** Deploys a new proxy contract with initialization parameters.

### Interacting with Contracts

#### Setting Wallets

```javascript
await daarContract.setWallets(ownerAddress, daarDistributor.address, aprStaking.address, { from: deployerAccount });
```

- **setWallets:** Configures the wallets in the `DAAR` and `DAARION` contracts.

#### Setting WalletD Role

```javascript
await daarContract.setWalletD(daarDistributor.address, { from: deployerAccount });
```

- **setWalletD:** Assigns the `WalletD` role to the `DAARDistributor` contract.

#### Transferring Ownership

```javascript
await daarContract.transferOwnership(ownerAddress, { from: deployerAccount });
```

- **transferOwnership:** Transfers ownership of the contract to the Gnosis Safe Wallet.

## Step-by-Step Deployment Guide

Follow these steps to run the deployment script.

### 1. Clone the Repository

Clone the repository containing the contracts and deployment script.

```bash
git clone <repository-url>
cd <repository-directory>
```

### 2. Install Dependencies

Install the required NPM packages.

```bash
npm install
```

### 3. Configure Network Settings

Ensure your `truffle-config.js` is set up for the network you intend to deploy to. For example:

```javascript
module.exports = {
  networks: {
    development: {
      host: "127.0.0.1",     // Localhost
      port: 8545,            // Standard Ethereum port
      network_id: "*",       // Any network
    },
    // Additional network configurations...
  },
  // Other configurations...
};
```

### 4. Unlock Accounts

Ensure the deployer account (`deployerAccount`) has sufficient ETH and is unlocked. If you're using a local development network like Ganache, accounts are typically unlocked by default.

If deploying to a testnet or mainnet, consider using a wallet provider like `HDWalletProvider`.

### 5. Verify Owner Address

Confirm that the `ownerAddress` (`0x39c8e3807B864A633bd83C34995d7A3a18d0b7e8`) is correct and accessible. Ensure that you have control over this address.

### 6. Deploy Contracts

Run the deployment script using Truffle.

```bash
truffle migrate --network <network-name>
```

Replace `<network-name>` with the name of the network defined in your `truffle-config.js`.

### 7. Monitor the Deployment

Watch the console output for progress and any errors. Successful deployment should output messages indicating:

- Deployment or retrieval of `DAARDistributor` and `APRStaking` contracts.
- Successful setting of wallets in `DAAR` and `DAARION` contracts.
- Assignment of the `WalletD` role.
- Transfer of ownership to the Gnosis Safe Wallet.

### 8. Verify Contracts on the Blockchain

After deployment, you may want to verify the contracts on a block explorer (e.g., Etherscan) if deploying to a public network.

### 9. Interact with the Contracts

Use Truffle console or other tools to interact with the deployed contracts and confirm that they are functioning as expected.

## Important Notes

- **Consistency of Contract Addresses:** The script checks for existing deployments to maintain consistent contract addresses. This is crucial for interacting with contracts that rely on specific addresses.
- **Initializer Parameters:** Ensure that the parameters provided to `deployProxy` match the initializer functions in your contracts.
- **Permissions:** The account used for deploying and signing transactions must have the necessary permissions and sufficient ETH to cover gas costs.
- **Upgrades:** If you need to upgrade contracts in the future, use `upgradeProxy` from the OpenZeppelin upgrades plugin.

## Troubleshooting

### Common Issues

1. **Owner Address Not Unlocked:**

   - **Symptoms:** Transactions fail due to lack of permissions.
   - **Resolution:** Ensure `ownerAddress` is either unlocked or that you have access to sign transactions from this address.

2. **Insufficient Funds:**

   - **Symptoms:** Transactions fail due to insufficient gas or funds.
   - **Resolution:** Ensure the deployer account has enough ETH to cover gas costs.

3. **Contract Already Deployed:**

   - **Symptoms:** Errors indicating that the contract has already been deployed.
   - **Resolution:** The script is designed to handle existing deployments. Ensure that the OpenZeppelin upgrades manifest is correctly tracking deployments.

4. **Incorrect Parameters:**

   - **Symptoms:** Contract functions revert due to invalid arguments.
   - **Resolution:** Verify that all parameters match the expected types and order in the contract's functions.

### Debugging Steps

- **Check Console Output:** Review the error messages provided in the console to identify the issue.
- **Review Contract Code:** Ensure that the contracts' functions and initializers are correctly defined.
- **Test Locally:** Deploy to a local development network like Ganache to test the script before deploying to a public network.
- **Consult Documentation:** Refer to the OpenZeppelin upgrades plugin documentation for guidance on deploying and upgrading contracts.

## Security Considerations

- **Private Keys:** Never expose private keys in code or commit them to version control.
- **Contract Audits:** Ensure that all contracts have been audited for security vulnerabilities.
- **Access Control:** Verify that only authorized accounts have access to administrative functions.
- **Upgradability Risks:** Be cautious when upgrading contracts, as changes can introduce new vulnerabilities.

## Contributing

Contributions to improve the deployment script or this README are welcome. Please follow these steps:

1. **Fork the Repository:** Create a fork on GitHub.
2. **Create a Branch:** Make a new branch for your changes.
3. **Commit Changes:** Make your modifications and commit them with clear messages.
4. **Submit a Pull Request:** Open a pull request to the main repository.

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.

---

*Disclaimer: This README is provided for informational purposes and does not constitute legal or financial advice.*
